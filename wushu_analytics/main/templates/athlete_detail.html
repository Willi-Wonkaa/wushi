{% extends 'base.html' %}

{% block title %}{{ participant.name }} - Wushu Analytics{% endblock %}

{% block page_title %}{{ participant.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back button and controls -->
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <a href="{% url 'athletes' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> –ö —Å–ø–∏—Å–∫—É —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤
        </a>
        
        <div class="btn-group" role="group">
            {% if not show_all %}
            <a href="?show_all=true" class="btn btn-outline-info">
                <i class="bi bi-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è
            </a>
            {% else %}
            <a href="?show_all=false" class="btn btn-outline-secondary">
                <i class="bi bi-eye-slash"></i> –°–∫—Ä—ã—Ç—å –Ω—É–ª–µ–≤—ã–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ competitions_count }}</h3>
                    <p class="card-text">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ performances_count }}</h3>
                    <p class="card-text">–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ avg_score }}</h3>
                    <p class="card-text">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ total_medals }}</h3>
                    <p class="card-text">–ú–µ–¥–∞–ª–∏</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Medals Breakdown -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value-gold">{{ gold_count }}</div>
                        <div class="stat-label">ü•á –ó–æ–ª–æ—Ç—ã–µ</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value-silver">{{ silver_count }}</div>
                        <div class="stat-label">ü•à –°–µ—Ä–µ–±—Ä—è–Ω—ã–µ</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value-bronze">{{ bronze_count }}</div>
                        <div class="stat-label">ü•â –ë—Ä–æ–Ω–∑–æ–≤—ã–µ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Score Timeline Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-graph-up"></i> –ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏</h6>
        </div>
        <div class="card-body">
            <canvas id="scoreTimelineChart" height="100"></canvas>
        </div>
    </div>

    <!-- Competitions Summary Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-trophy"></i> –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è ({{ competitions_data|length }})</h6>
        </div>
        <div class="card-body">
            {% if competitions_data %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ</th>
                            <th>–ì–æ—Ä–æ–¥</th>
                            <th>–î–∞—Ç—ã</th>
                            <th>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                            <th>–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp_data in competitions_data %}
                        <tr>
                            <td>
                                <a href="{% url 'competitions' %}?competition_id={{ comp_data.competition.id }}" class="text-primary">
                                    {{ comp_data.competition.name }}
                                </a>
                            </td>
                            <td><i class="bi bi-geo-alt text-muted"></i> {{ comp_data.competition.sity }}</td>
                            <td>{{ comp_data.competition.start_date|date:"d.m.Y" }} - {{ comp_data.competition.end_date|date:"d.m.Y" }}</td>
                            <td><span class="badge bg-info">{{ comp_data.participants_count }}</span></td>
                            <td><span class="badge bg-primary">{{ comp_data.performances_count }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-calendar-x display-4 text-muted"></i>
                <p class="text-muted mt-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è—Ö</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Detailed Competition Blocks -->
    {% for comp_data in competitions_data %}
    <div class="card mb-4 competition-block">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">{{ comp_data.competition.name }}</h5>
                    <small>
                        <i class="bi bi-geo-alt"></i> {{ comp_data.competition.sity }} | 
                        <i class="bi bi-calendar"></i> {{ comp_data.competition.start_date|date:"d.m.Y" }} - {{ comp_data.competition.end_date|date:"d.m.Y" }} |
                        <i class="bi bi-people"></i> {{ comp_data.participants_count }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                    </small>
                </div>
                <a href="{% url 'competitions' %}?competition_id={{ comp_data.competition.id }}" class="btn btn-light btn-sm">
                    <i class="bi bi-box-arrow-up-right"></i> –ü–µ—Ä–µ–π—Ç–∏
                </a>
            </div>
        </div>
        <div class="card-body">
            <!-- Score Distribution Histogram for Age Category -->
            {% if comp_data.age_category %}
            <div class="mb-4">
                <h6><i class="bi bi-bar-chart"></i> –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –≤ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {{ comp_data.age_category }}</h6>
                <canvas id="histogram-{{ comp_data.competition.id }}" height="60"></canvas>
            </div>
            {% endif %}

            <!-- Each Performance -->
            {% for perf_data in comp_data.performances %}
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">{{ perf_data.category_name }}</h6>
                        <small class="text-muted">{{ perf_data.performance.origin_title }}</small>
                    </div>
                    <div>
                        {% if perf_data.place == 1 %}
                            <span class="badge bg-warning text-dark">ü•á 1 –º–µ—Å—Ç–æ</span>
                        {% elif perf_data.place == 2 %}
                            <span class="badge bg-secondary">ü•à 2 –º–µ—Å—Ç–æ</span>
                        {% elif perf_data.place == 3 %}
                            <span class="badge bg-danger">ü•â 3 –º–µ—Å—Ç–æ</span>
                        {% else %}
                            <span class="badge bg-info">{{ perf_data.place }} –º–µ—Å—Ç–æ</span>
                        {% endif %}
                        {% if perf_data.performance.mark %}
                            <span class="badge bg-success">{{ perf_data.performance.mark }} –±–∞–ª–ª–æ–≤</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Category Participants Table -->
                    <div class="table-responsive mb-3">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>–ò–º—è</th>
                                    <th>–†–µ–≥–∏–æ–Ω</th>
                                    <th>–ü–æ–ª</th>
                                    <th>–í—Ä–µ–º—è</th>
                                    <th>–ë–∞–ª–ª—ã</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cat_perf in perf_data.category_performances %}
                                <tr {% if cat_perf.participant.id == participant.id %}class="table-primary"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        {% if cat_perf.participant.id == participant.id %}
                                            <strong>{{ cat_perf.participant.name }}</strong>
                                        {% else %}
                                            {{ cat_perf.participant.name }}
                                        {% endif %}
                                    </td>
                                    <td>{{ cat_perf.participant.sity }}</td>
                                    <td>
                                        {% if cat_perf.ages_category %}
                                            {% if cat_perf.ages_category.sex == '–ú' %}
                                                <span class="badge bg-primary">–ú</span>
                                            {% else %}
                                                <span class="badge bg-danger">–ñ</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ cat_perf.est_start_datetime|date:"H:i" }}</td>
                                    <td>
                                        {% if cat_perf.mark %}
                                            <span class="badge bg-success">{{ cat_perf.mark }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Scores Scatter Chart -->
                    <div class="mb-2">
                        <h6><i class="bi bi-scatter-chart"></i> –ì—Ä–∞—Ñ–∏–∫ –±–∞–ª–ª–æ–≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h6>
                        <canvas id="scatter-{{ comp_data.competition.id }}-{{ forloop.counter }}" height="80"></canvas>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<style>
.stat-mini {
    padding: 0.5rem;
}
.stat-value-mini {
    font-size: 1.5rem;
    font-weight: 700;
}
.stat-label-mini {
    font-size: 0.75rem;
    color: var(--text-secondary);
}
.competition-block .card-header.bg-primary {
    background: var(--gradient-primary) !important;
}
.table-primary {
    background-color: rgba(0, 136, 204, 0.2) !important;
}
.table-primary td {
    background-color: rgba(0, 136, 204, 0.1) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Score Timeline Chart
    const scoreTimeline = {{ score_timeline|safe }};
    
    if (scoreTimeline.length > 0) {
        const timelineCtx = document.getElementById('scoreTimelineChart').getContext('2d');
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: scoreTimeline.map(item => item.date),
                datasets: [{
                    label: '–ë–∞–ª–ª',
                    data: scoreTimeline.map(item => item.score),
                    borderColor: '#0088cc',
                    backgroundColor: 'rgba(0, 136, 204, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#0088cc',
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const item = scoreTimeline[context.dataIndex];
                                return item.competition + '\n' + item.category;
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: Math.min(...scoreTimeline.map(i => i.score)) - 0.5,
                        max: Math.max(...scoreTimeline.map(i => i.score)) + 0.5,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }

    // Histogram charts for each competition
    {% for comp_data in competitions_data %}
    {% if comp_data.age_category_scores %}
    (function() {
        const scores = {{ comp_data.age_category_scores|safe }};
        if (scores.length > 0) {
            // Create histogram bins
            const minScore = Math.floor(Math.min(...scores));
            const maxScore = Math.ceil(Math.max(...scores));
            const binSize = 0.5;
            const bins = [];
            const binLabels = [];
            
            for (let i = minScore; i <= maxScore; i += binSize) {
                bins.push(0);
                binLabels.push(i.toFixed(1));
            }
            
            scores.forEach(score => {
                const binIndex = Math.floor((score - minScore) / binSize);
                if (binIndex >= 0 && binIndex < bins.length) {
                    bins[binIndex]++;
                }
            });
            
            const histCtx = document.getElementById('histogram-{{ comp_data.competition.id }}');
            if (histCtx) {
                new Chart(histCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: binLabels,
                        datasets: [{
                            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π',
                            data: bins,
                            backgroundColor: 'rgba(0, 136, 204, 0.6)',
                            borderColor: '#0088cc',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }
    })();
    {% endif %}
    {% endfor %}

    // Scatter charts for category performances
    {% for comp_data in competitions_data %}
    {% for perf_data in comp_data.performances %}
    (function() {
        const scatterData = [
            {% for cat_perf in perf_data.category_performances %}
            {% if cat_perf.mark %}
            {
                x: {{ forloop.counter }},
                y: {{ cat_perf.mark }},
                name: "{{ cat_perf.participant.name }}",
                city: "{{ cat_perf.participant.sity }}",
                isHighlighted: {{ cat_perf.participant.id }} === {{ participant.id }}
            },
            {% endif %}
            {% endfor %}
        ];
        
        if (scatterData.length > 0) {
            const scatterCtx = document.getElementById('scatter-{{ comp_data.competition.id }}-{{ forloop.counter }}');
            if (scatterCtx) {
                new Chart(scatterCtx.getContext('2d'), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: '–£—á–∞—Å—Ç–Ω–∏–∫–∏',
                            data: scatterData.map(d => ({x: d.x, y: d.y})),
                            pointBackgroundColor: scatterData.map(d => d.isHighlighted ? '#ff6b6b' : '#0088cc'),
                            pointBorderColor: scatterData.map(d => d.isHighlighted ? '#ff6b6b' : '#0088cc'),
                            pointRadius: scatterData.map(d => d.isHighlighted ? 10 : 6),
                            pointHoverRadius: 12,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const item = scatterData[context.dataIndex];
                                        return item.name + ' (' + item.city + ') - ' + item.y + ' –±–∞–ª–ª–æ–≤';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: '–ë–∞–ª–ª—ã' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                title: { display: true, text: '–£—á–∞—Å—Ç–Ω–∏–∫ #' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }
    })();
    {% endfor %}
    {% endfor %}
});
</script>
{% endblock %}
